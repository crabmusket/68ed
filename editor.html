<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>68ed</title>
  <style type="text/css" media="screen">
    body {
        overflow: hidden;
    }
    
    #editor { 
        margin: 0;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
    }
  </style>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
</head>
<body>

<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

<pre id="editor">
****************************************
*   -- Sample Program --
*   This program writes a series of
*   characters from a phrase to PORTB
*****************************************
REGBASE equ     $1000
PORTB   equ     $04

        org     $0000

init:
        ldx     #phrase
        ldy     #REGBASE
loop:
        ldaa    0,x
        beq     init
        staa    PORTB,y
        inx
        jmp     loop
phrase:
        fcb     "Hello, world!"
</pre>
    
<script>
function bit(i, b) {
    return i & (1 << b);
}

function getColor(i, a) {
    var r = bit(i, 1) + bit(i, 3) * 2 + 1;
    var g = bit(i, 2) + bit(i, 4) * 2 + 1;
    var b = bit(i, 0) + bit(i, 5) * 2 + 1;
    if (i == 0) a = 0;
    return 'rgba(' +
        r*63 + ',' +
        g*63 + ',' +
        b*63 + ',' +
        a + ')';
}

function isLabel(line) {
    return line.match(/^.*\:/);
}

function isBranch(line) {
    var branches = [
        'bcc', 'bcs', 'beq', 'bge', 'bgt', 'bhi', 'bhs', 'ble', 'blo', 'bls', 'blt', 
        'bmi', 'bne', 'bpl', 'bra', 'brclr', 'brset', 'bsr', 'bvc', 'bvs', 'jmp', 'jsr',
        'rts', 'rti'
    ];
    for (var i = 0; i < branches.length; i++) {
        var r = new RegExp('^\\s*' + branches[i]);
        if (line.match(r))
            return true;
    }
    return false;
}

function updateBlocks() {
    var block = 0;
    var lines = editor.getSession().getDocument().getAllLines();
    for (var i = 0; i < lines.length; i++) {
        var text = lines[i];
        var label = false;
        // If this line is a label, start a new block.
        if (isLabel(text)) {
            block += 1;
            label = true;
        }
        // Highlight the gutter with the appropriate block style.
        editor.getSession().$decorations[i] = "";
        if (block > 0)
            editor.getSession().addGutterDecoration(i, "block" + (block % 10));
        // If this was a branch or jump, the next line begins a new block.
        if (!label && isBranch(text)) {
            block += 1;
        }
    }
}

var editor = ace.edit("editor");
editor.setTheme("ace/theme/dark");
editor.getSession().setMode("ace/mode/asm68hc11");
editor.getSession().on("change", function(e) {
    setTimeout(updateBlocks, 0);
});
editor.getSession().on("tokenizerUpdate", function() {
    setTimeout(updateBlocks, 0);
});
</script>

</body>
</html>
